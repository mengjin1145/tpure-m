# 浏览器缓存排除规则说明

## 🎯 为什么需要排除缓存？

某些文件必须**每次都执行**，不能使用缓存，包括：
- API 接口（实时数据）
- 跟踪脚本（需要收集最新数据）
- 指纹采集（需要实时生成）
- 动态内容生成器

---

## 📋 已排除的文件列表

### 1. **AdvancedStats 插件文件**

#### `/zb_users/plugin/AdvancedStats/track.js`
- **类型：** 跟踪脚本
- **功能：** 收集用户行为数据（页面访问、停留时间等）
- **为什么不缓存：**
  ```javascript
  // track.js 需要实时收集数据
  var visitData = {
      timestamp: Date.now(),        // ← 必须是当前时间
      pageUrl: window.location.href, // ← 必须是当前页面
      sessionId: generateSessionId() // ← 每次访问都不同
  };
  ```
  如果被缓存，收集的都是旧数据！❌

#### `/zb_users/plugin/AdvancedStats/track_api.php`
- **类型：** API 接口
- **功能：** 接收并存储访问数据
- **为什么不缓存：**
  ```php
  // 接收 POST 数据并存储到数据库
  $data = json_decode(file_get_contents('php://input'), true);
  
  // 每次请求都必须执行，不能返回缓存的响应
  saveVisitData($data);  // ← 必须实时写入数据库
  ```
  如果被缓存，数据无法写入数据库！❌

#### `/zb_users/plugin/AdvancedStats/get_fingerprint_data.php`
- **类型：** 指纹数据接口
- **功能：** 返回设备指纹信息
- **为什么不缓存：**
  ```php
  // 生成唯一的设备指纹
  $fingerprint = array(
      'canvas_hash' => generateCanvasHash(),  // ← 每次都不同
      'webgl_info'  => getWebGLInfo(),        // ← 设备相关
      'timestamp'   => time()                 // ← 当前时间
  );
  
  echo json_encode($fingerprint);
  ```
  如果被缓存，所有用户拿到的都是同一个指纹！❌

#### `/zb_users/plugin/AdvancedStats/stay_time.php`
- **类型：** 停留时间记录接口
- **功能：** 记录用户在页面停留的时间
- **为什么不缓存：**
  ```php
  // 记录页面停留时间
  $stayTime = $_POST['duration'];  // ← 实时数据
  $pageId = $_POST['page_id'];
  
  updateStayTime($pageId, $stayTime);  // ← 必须写入数据库
  ```

---

### 2. **系统核心接口**

#### `/api.php`
- **类型：** Z-BlogPHP API 接口
- **功能：** 系统级 API 调用
- **为什么不缓存：**
  ```php
  // 各种动态操作
  switch ($action) {
      case 'login':   // 登录（每次都不同）
      case 'comment': // 评论（实时提交）
      case 'upload':  // 上传（实时处理）
  }
  ```

#### `/cmd.php`
- **类型：** 命令处理接口
- **功能：** 执行系统命令
- **为什么不缓存：**
  ```php
  // 执行后台命令
  $cmd = $_POST['cmd'];
  executeCommand($cmd);  // ← 必须实时执行
  ```

---

## 🔧 实现代码

**文件：** `lib/http-cache.php` 第91-106行

```php
// 🆕 插件动态文件不缓存（API、跟踪脚本等）
$noCachePatterns = array(
    '/zb_users/plugin/AdvancedStats/track.js',
    '/zb_users/plugin/AdvancedStats/track_api.php',
    '/zb_users/plugin/AdvancedStats/get_fingerprint_data.php',
    '/zb_users/plugin/AdvancedStats/stay_time.php',
    '/api.php',
    '/cmd.php',
);

foreach ($noCachePatterns as $pattern) {
    if (strpos($requestUri, $pattern) !== false) {
        self::setNoCache();  // 发送不缓存的响应头
        return;
    }
}
```

**响应头：**
```http
HTTP/1.1 200 OK
Cache-Control: no-store, no-cache, must-revalidate, max-age=0
Pragma: no-cache
Expires: Mon, 26 Jul 1997 05:00:00 GMT
```

---

## 📊 排除前后对比

### ❌ 如果被缓存（错误）

```
第一次访问 track.js：
  浏览器 → 服务器："我要 track.js"
  服务器 → 浏览器："给你，可以缓存7天"
  浏览器：保存到本地 ✅

第二次访问（7天内）：
  浏览器：直接用缓存的 track.js ❌
  
问题：
  - 收集的 timestamp 是7天前的 ❌
  - sessionId 是旧的 ❌
  - 无法收集新数据 ❌
```

### ✅ 排除缓存后（正确）

```
每次访问 track.js：
  浏览器 → 服务器："我要 track.js"
  服务器 → 浏览器："给你，不要缓存（Cache-Control: no-cache）"
  浏览器：使用文件，但不保存到缓存 ✅

下次访问：
  浏览器 → 服务器："我要 track.js"（重新请求）
  服务器 → 浏览器："给你最新的"
  
结果：
  - timestamp 是当前时间 ✅
  - sessionId 是新的 ✅
  - 数据收集正常 ✅
```

---

## 🔍 如何验证排除规则生效？

### 方法1：Chrome 开发者工具

1. 打开网站，按 `F12`
2. 切换到 **Network（网络）** 标签
3. 访问一个包含 `track.js` 的页面
4. 查找 `track.js` 文件

**检查响应头：**
```
Response Headers:
  Cache-Control: no-store, no-cache, must-revalidate, max-age=0
  Pragma: no-cache
  Expires: Mon, 26 Jul 1997 05:00:00 GMT

如果看到以上响应头 → 排除成功 ✅
如果看到 "max-age=604800" → 排除失败 ❌
```

**检查缓存状态：**
```
刷新页面多次，每次都应该显示：
  Status: 200 OK
  Size: 实际文件大小（如 15.2 KB）

不应该显示：
  Status: 200 (from disk cache)  ← 说明被缓存了 ❌
  Status: 304 Not Modified       ← 说明在使用缓存 ❌
```

---

### 方法2：使用 curl 命令

```bash
# 测试 track.js
curl -I https://www.dcyzq.com/zb_users/plugin/AdvancedStats/track.js

# 应该看到：
HTTP/1.1 200 OK
Cache-Control: no-store, no-cache, must-revalidate, max-age=0
Pragma: no-cache
Expires: Mon, 26 Jul 1997 05:00:00 GMT
```

```bash
# 测试 track_api.php
curl -I https://www.dcyzq.com/zb_users/plugin/AdvancedStats/track_api.php

# 应该看到相同的不缓存响应头
```

---

### 方法3：创建测试工具

**文件：** `test-no-cache.php`

```php
<?php
require '../../../zb_system/function/c_system_base.php';
$zbp->Load();

// 测试文件列表
$testFiles = array(
    'track.js',
    'track_api.php',
    'get_fingerprint_data.php',
    'stay_time.php',
);

echo '<h1>缓存排除规则测试</h1>';

foreach ($testFiles as $file) {
    $url = $zbp->host . 'zb_users/plugin/AdvancedStats/' . $file;
    
    // 使用 curl 获取响应头
    $ch = curl_init($url);
    curl_setopt($ch, CURLOPT_NOBODY, true);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
    curl_setopt($ch, CURLOPT_HEADER, true);
    $response = curl_exec($ch);
    curl_close($ch);
    
    // 检查 Cache-Control
    echo '<h2>' . $file . '</h2>';
    
    if (strpos($response, 'Cache-Control: no-cache') !== false) {
        echo '<p style="color: green;">✅ 已排除缓存</p>';
    } else {
        echo '<p style="color: red;">❌ 仍在缓存</p>';
    }
    
    echo '<pre>' . htmlspecialchars($response) . '</pre>';
}
?>
```

---

## ⚙️ 如何添加新的排除规则？

**步骤：**

1. 打开 `lib/http-cache.php`
2. 找到第92-99行的 `$noCachePatterns` 数组
3. 添加新的文件路径

```php
$noCachePatterns = array(
    '/zb_users/plugin/AdvancedStats/track.js',
    '/zb_users/plugin/AdvancedStats/track_api.php',
    '/zb_users/plugin/AdvancedStats/get_fingerprint_data.php',
    '/zb_users/plugin/AdvancedStats/stay_time.php',
    '/api.php',
    '/cmd.php',
    
    // 👇 添加新的排除规则
    '/zb_users/plugin/MyPlugin/realtime.php',  // 实时API
    '/zb_users/theme/tpure/ajax.php',          // 主题AJAX接口
);
```

4. 保存文件，上传到服务器
5. 访问对应文件，验证响应头

---

## 🎯 排除规则的优先级

```
1. 后台页面（ZBP_IN_ADMIN）       → 不缓存
2. 已登录用户（Level 1-4）         → 不缓存
3. 系统路径（/zb_system/）         → 不缓存
4. 动态文件列表（$noCachePatterns） → 不缓存
5. 其他文件                        → 按类型缓存
```

**处理顺序（从上到下）：**

```php
// 优先级1：后台
if (ZBP_IN_ADMIN) {
    setNoCache();
    return;  // ← 立即返回，不再检查后续规则
}

// 优先级2：已登录用户
if ($zbp->user->Level <= 4) {
    setNoCache();
    return;
}

// 优先级3：系统路径
if (strpos($uri, '/zb_system/') !== false) {
    setNoCache();
    return;
}

// 优先级4：动态文件列表
foreach ($noCachePatterns as $pattern) {
    if (strpos($uri, $pattern) !== false) {
        setNoCache();
        return;
    }
}

// 优先级5：其他文件 - 检测类型并应用缓存
$maxAge = detectCacheTime();  // 图片30天、CSS7天等
setCacheHeaders('text/html', $maxAge);
```

---

## ⚠️ 注意事项

### 1. **不要过度排除**

```php
// ❌ 错误：排除所有插件
if (strpos($uri, '/zb_users/plugin/') !== false) {
    setNoCache();
}

// ✅ 正确：只排除动态文件
$noCachePatterns = array(
    '/zb_users/plugin/AdvancedStats/track_api.php',  // API
    '/zb_users/plugin/AdvancedStats/track.js',       // 实时脚本
);
```

**原因：**
- 插件的 CSS/图片等静态资源应该缓存
- 只有 API、实时脚本等需要排除

---

### 2. **静态 JS 应该缓存 + 版本号**

```php
// ❌ 错误：所有 JS 都不缓存
if (preg_match('/\.js$/', $uri)) {
    setNoCache();
}

// ✅ 正确：静态 JS 使用缓存+版本号
<script src="stay_time_tracker.js?v=1.5.2"></script>  // ← 缓存7天，版本号控制更新

// ✅ 动态 JS 不缓存
<script src="track.js"></script>  // ← 实时收集数据，不缓存
```

---

### 3. **区分静态和动态**

| 文件 | 类型 | 是否缓存 | 理由 |
|-----|------|---------|------|
| `stay_time_tracker.js` | 静态脚本 | ✅ 缓存+版本号 | 代码不常变化 |
| `track.js` | 动态跟踪 | ❌ 不缓存 | 需要实时收集数据 |
| `track_api.php` | API接口 | ❌ 不缓存 | 每次都写入数据库 |
| `function.php` | 静态库 | ✅ 缓存+版本号 | 函数定义不常变 |
| `get_fingerprint_data.php` | 动态API | ❌ 不缓存 | 实时生成指纹 |

---

## 📈 性能影响

### 排除缓存的文件

```
每次访问都请求服务器：
  - track.js: 15 KB
  - track_api.php: 0.5 KB（JSON响应）
  - get_fingerprint_data.php: 2 KB
  
总计：约 17.5 KB / 次

影响：
  - 流量增加：17.5 KB × 1000次/天 = 17.5 MB/天
  - 服务器请求增加：3个文件 × 1000次 = 3000次/天
  
但这是必要的，因为：
  ✅ 保证数据收集的准确性
  ✅ 避免统计数据错误
  ✅ 17.5 MB 相比总流量（数GB）影响很小
```

### 缓存的文件

```
仍然缓存的静态资源：
  - stay_time_tracker.js: 20 KB（缓存7天）
  - logo.png: 100 KB（缓存30天）
  - style.css: 50 KB（缓存7天）
  
节省流量：
  - 170 KB × 70%回访率 × 1000次/天 = 119 MB/天
  
总体效果：
  - 流量节省：119 MB - 17.5 MB = 101.5 MB/天 ✅
  - 性能提升：仍然很显著 ✅
```

---

## 🎓 总结

### 缓存策略

```
静态资源（图片、CSS、静态JS） → 缓存 + 版本号控制
动态接口（API、跟踪脚本）      → 不缓存
后台页面                      → 不缓存
已登录用户                    → 不缓存
```

### 核心原则

1. ✅ **能缓存的尽量缓存**（性能优先）
2. ⚠️ **必须实时的坚决不缓存**（准确性优先）
3. 🔧 **使用版本号解决更新问题**（灵活性）

---

**相关文档：**
- [浏览器缓存HTTP说明.md](./浏览器缓存HTTP说明.md)
- [JS缓存影响说明.md](./JS缓存影响说明.md)
- [JS版本号控制实施指南.md](./JS版本号控制实施指南.md)

